var ifRecorder={sessionId:(new Date).getTime()+""+Math.ceil(Math.random()*1E3),command:{input:"",timestamp:0},output:"",cache:[],statusline:"",window:0,turncount:0,inputcount:0,outputcount:1,styles:"",saveUrl:"",story:{name:"",version:""},info:"",interpreter:typeof parchment!="undefined"?"Parchment":"Undum",optOut:typeof getUrlVars().feedback!="undefined"&&getUrlVars().feedback!="1",serverOffline:false,send:function(a,b,c,g){if(this.collectTranscripts()){if(typeof a!="undefined")this.window=a;if(typeof b!=
"undefined")this.styles=b;if(typeof c!="undefined")this.output=c;a={session:this.sessionId,log:{inputcount:this.inputcount,outputcount:this.outputcount,input:this.command.input,output:this.output,window:this.window,styles:this.styles,timestamp:(new Date).getTime()}};if(g)this.cache.push(a);else{if(this.cache.length>0)this.cache.push(a),a=this.cache,this.cache=[];jQuery.ajax({type:"POST",url:this.saveUrl,data:{data:a}})}this.output="";this.outputcount++}},sendCache:function(){if(this.collectTranscripts()&&
this.cache.length>0)jQuery.ajax({type:"POST",url:this.saveUrl,data:{data:this.cache}}),this.cache=[]},collectTranscripts:function(){return this.saveUrl==""||this.optOut||this.serverOffline?false:true},initialize:function(a){var b=this;if(typeof a=="string")b.saveUrl=a;if(typeof undum!="undefined"){if(b.story.name=="")b.story.name=undum.game.id;if(b.story.version=="")b.story.version=undum.game.version}if(b.story.name==""){if(typeof parchment.options.default_story!="undefined"&&parchment.options.default_story!=
"")b.story.name=parchment.options.default_story;if(!parchment.options.lock_story&&typeof getUrlVars().story!="undefined"&&getUrlVars().story!="")b.story.name=getUrlVars().story}if(b.story.name=="")b.story.name="(unknown)";if(!b.collectTranscripts())return false;jQuery.ajax({type:"POST",url:b.saveUrl,data:{data:{session:b.sessionId,start:{story:b.story.name,version:b.story.version,info:b.info,interpreter:b.interpreter,browser:jQuery.browser.name+" "+jQuery.browser.version+" "+jQuery.os.name}}},error:function(){b.serverOffline=
true},success:function(c){if(c.toLowerCase()!="ok")b.serverOffline=true}});return true},charName:function(a){switch(a){case Event.KEY_BACKSPACE:return"<backspace>";case 4294967289:return"<backspace/delete>";case Event.KEY_TAB:case 4294967287:return"<tab>";case 13:case 4294967290:return"<enter>";case Event.KEY_ESC:case 4294967288:return"<esc>";case 32:return"<space>";case Event.KEY_LEFT:case 4294967294:return"<left>";case Event.KEY_UP:case 4294967292:return"<up>";case Event.KEY_RIGHT:case 4294967293:return"<right>";
case Event.KEY_DOWN:case 4294967291:return"<down>";case 46:return"<del>";case Event.KEY_PAGEUP:case 4294967286:return"<pgup>";case Event.KEY_PAGEDOWN:case 4294967285:return"<pgdown>";case Event.KEY_HOME:case 4294967284:return"<home>";case Event.KEY_END:case 4294967283:return"<end>";case 4294967279:return"<F1>";case 4294967278:return"<F2>";case 4294967277:return"<F3>";case 4294967276:return"<F4>";case 4294967275:return"<F5>";case 4294967274:return"<F6>";case 4294967273:return"<F7>";case 4294967272:return"<F8>";
case 4294967271:return"<F9>";case 4294967270:return"<F10>";case 4294967269:return"<F11>";case 4294967268:return"<F12>";default:return String.fromCharCode(a)}},undum:{oldContentLength:0,prepare:function(a){ifRecorder.command.input=a;this.oldContentLength=jQuery("#content").html().length},send:function(){var a=ifRecorder;a.inputcount++;a.output=jQuery("#content").html().substring(this.oldContentLength);a.send()}}};
jQuery(document).ready(function(a){a(document).bind("LineInput",function(c){ifRecorder.command=c;ifRecorder.inputcount++});a(document).bind("CharInput",function(c){ifRecorder.command=c;ifRecorder.command.input=ifRecorder.charName(c.input.keyCode);ifRecorder.inputcount++});a(document).bind("TextOutput",function(c){c.output.window==0&&ifRecorder.send(c.output.window,c.output.styles,c.output.text)});a(document).bind("GlkOutput",function(c){if(typeof c.output!=="undefined"){for(var a=0;a<c.output.length;++a)if(typeof c.output[a].text!==
"undefined")for(var b=0;b<c.output[a].text.length;++b)if(ifRecorder.styles="",ifRecorder.output="\n",typeof c.output[a].text[b].content!="undefined")for(var d=0;d<c.output[a].text[b].content.size();d+=2)ifRecorder.styles=c.output[a].text[b].content[d],ifRecorder.output=c.output[a].text[b].content[d+1],d==c.output[a].text[b].content.size()-2&&(ifRecorder.output+="\n"),ifRecorder.send(ifRecorder.window,ifRecorder.styles,ifRecorder.output,true);else ifRecorder.send(ifRecorder.window,ifRecorder.styles,
ifRecorder.output,true);ifRecorder.sendCache()}});var b=function(){Console.prototype.renderHtml=function(){for(var a="",b="",e=0;e<this.height;e++){for(var d=null,f=0;f<this.width;f++)this._styles[e][f]!==d&&(d!==null&&(ifRecorder.send(1,d,b.replace(/\&nbsp\;/gi," ")),b="",a+="</span>"),d=this._styles[e][f],d!==null&&(a+='<span class="'+d+'">')),a+=this._characters[e][f],b+=this._characters[e][f];d!==null&&(a+="</span>",ifRecorder.send(1,d,b.replace(/\&nbsp\;/gi," ")+"\n"),b="");a+="<br/>"}return a};
a(document).unbind("TextOutput",b)};a(document).bind("TextOutput",b)}(jQuery));function getUrlVars(){for(var a=[],b,c=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),g=0;g<c.length;g++)b=c[g].split("="),a.push(b[0]),a[b[0]]=b[1];return a};
